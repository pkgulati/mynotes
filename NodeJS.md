### require
require will treat internal modules and user modules differently.
For Native module NativeModule.require will get invoked, which internally will call NativeModule.compile
For User Modules and Module.prototype.load will get called (after create of new Module)
Module.load will call extension handlers based on extension, like for .js file 

### .js extension handler
Following method is called to load user module js file
```
Module._extensions['.js'] = function(module, filename) {
  var content = fs.readFileSync(filename, 'utf8');
  module._compile(stripBOM(content), filename);
};
```
### Module._compile
This is called by js extension handler 

### lib/internal/modules/cjs/loader.js
This file has methods like Module._compile,

### NativeModule
NativeModule is internal/bootstrap/loaders.js

### bootstrap/loaders
file name lib/internal/bootstrap/loaders.js
inputs process, getBinding, getLinkedBinding, getInternalBinding, debugBreak

### Internal JavaScript module loader:
NativeModule: a minimal module system used to load the JavaScript core modules found in lib/**/*.js and deps/**/*.js. All core modules are
compiled into the node binary via node_javascript.cc generated by js2c.py, so they can be loaded faster without the cost of I/O. This class makes the lib/internal/*, deps/internal/* modules and internalBinding() available by default to core modules, and lets the core modules require itself via require('internal/bootstrap/loaders') even when this file is not written in CommonJS style.

## General
Before node.js file is run, lib/internal/bootstrap/loaders.js gets run first to bootstrap the internal binding and module loaders, including process.binding(), process._linkedBinding(), internalBinding() and NativeModule. 
And then { internalBinding, NativeModule } will be passed into this bootstrapper to bootstrap Node.js core.

## Internal JS to C example 
process.binding is used to invoke C method from JS
For example fs.readSync method invokes readSync in lib/fs.js which in turn will call
```
const result = binding.read(fd, buffer, offset, length, position,
                              undefined, ctx);
```  
Where binding is 
```
const binding = process.binding('fs');
```
Similarl to fs we have internal modules like
```
process.binding('v8');
process.binding('util')
process.binding('http2')
process.binding('contextify');
process.binding('constants')
process.binding('crypto')
process.binding('http_parser')
process.binding('tcp_wrap')
process.binding('config')
process.binding('trace_events')
```

### Inside C code Internal modules
Internal modules are registered using NODE_BUILTIN_MODULE_CONTEXT_AWARE macro 
For example in fs module is registered in node_file.cc 
NODE_BUILTIN_MODULE_CONTEXT_AWARE(fs, node::fs::Initialize)

## Method mapping in C
In node_file.cc, js method name read is mapped to actual C Read method
```
void Initialize(Local<Object> target,
                Local<Value> unused,
                Local<Context> context,
                void* priv) {
                
env->SetMethod(target, "read", Read);

```

### Read method Example in node_file.cc
```
/*
 * Wrapper for read(2).
 *
 * bytesRead = fs.read(fd, buffer, offset, length, position)
 *
 * 0 fd        int32. file descriptor
 * 1 buffer    instance of Buffer
 * 2 offset    int32. offset to start reading into inside buffer
 * 3 length    int32. length to read
 * 4 position  int64. file position - -1 for current position
 */
static void Read(const FunctionCallbackInfo<Value>& args) {

```

## Script Compile and execution
node_contextify.cc
node_contextify.cc:    ScriptCompiler::Source source(code, origin, cached_data);

ModuleWrap::New -> 
ScriptCompiler::Source source(source_text, origin);

## links
https://gist.github.com/nkuln/3272323

### Debug Inspect Get Source Code
Debugger.getScriptSource method is used to get source 
```
InspectorIo::PostIncomingMessage {"id":194,"method":"Debugger.getScriptSource","params":{"scriptId":"82"}}
InspectorIo::Write {"id":194,"result":{"scriptSource":"(function (exports, require, module, process) {'use strict';\n\nconst {\n  Hash: _Hash,\n  Hmac: _Hmac\n} = process.binding('crypto');\n\nconst {\n  getDefaultEncoding,\n  toBuf\n} = require('internal/crypto/util');\n\nconst { Buffer } = require('buffer');\n\nconst {\n  ERR_CRYPTO_HASH_DIGEST_NO_UTF16,\n  ERR_CRYPTO_HASH_FINALIZED,\n  ERR_CRYPTO_HASH_UPDATE_FAILED,\n  ERR_INVALID_ARG_TYPE\n} = require('internal/errors').codes;\nconst { inherits } = require('util');\nconst { normalizeEncoding } = require('internal/util');\nconst { isArrayBufferView } = require('internal/util/types');\nconst LazyTransform = require('internal/streams/lazy_transform');\nconst kState = Symbol('state');\nconst kFinalized = Symbol('finalized');\n\nfunction Hash(algorithm, options) {\n  if (!(this instanceof Hash))\n    return new Hash(algorithm, options);\n  if (typeof algorithm !== 'string')\n    throw new ERR_INVALID_ARG_TYPE('algorithm', 'string', algorithm);\n  this._handle = new _Hash(algorithm);\n  this[kState] = {\n    [kFinalized]: false\n  };\n  LazyTransform.call(this, options);\n}\n\ninherits(Hash, LazyTransform);\n\nHash.prototype._transform = function _transform(chunk, encoding, callback) {\n  this._handle.update(chunk, encoding);\n  callback();\n};\n\nHash.prototype._flush = function _flush(callback) {\n  this.push(this._handle.digest());\n  callback();\n};\n\nHash.proto
```

### v8 debugger source file
src/inspector/v8-debugger-agent-impl.h

### scriptParsed event
Debugger.scriptParsed event sent to inspector from nodejs/v8
```
InspectorIo::Write {"id":29,"result":{}}
InspectorIo::Write {"error":{"code":-32601,"message":"'Page.setAdBlockingEnabled' wasn't found"},"id":30}
InspectorIo::Write {"method":"Debugger.scriptParsed","params":{"scriptId":"11","url":"internal/bootstrap/loaders.js","startLine":0,"startColumn":0,"endLine":307,"endColumn":0,"executionContextId":1,"hash":"2c280334a95656e92416d910634ee6a011273e84","executionContextAuxData":{"isDefault":true},"isLiveEdit":false,"sourceMapURL":"","hasSourceURL":false,"isModule":false,"length":10294}}
InspectorIo::Write {"method":"Debugger.scriptParsed","params":{"scriptId":"12","url":"internal/bootstrap/node.js","startLine":0,"startColumn":0,"endLine":585,"endColumn":0,"executionContextId":1,"hash":"029e3f5442fddb9501f2b27369ce8b4b1bf465a8","executionContextAuxData":{"isDefault":true},"isLiveEdit":false,"sourceMapURL":"","hasSourceURL":false,"isModule":false,"length":20516}}
InspectorIo::Write {"method":"Debugger.scriptParsed","params":{"scriptId":"13","url":"events.js","startLine":0,"startColumn":0,"endLine":483,"endColumn":3,"executionContextId":1,"hash":"30146c342aa2fa228266451b2753d18626452880","executionContextAuxData":{"isDefault":true},"isLiveEdit":false,"sourceMapURL":"","hasSourceURL":false,"isModule":false,"length":14535,"stackTrace":{"callFrames":[{"functionName":"NativeModule.compile","scriptId":"11","url":"internal/bootstrap/loaders.js","lineNumber":231,"columnNumber":21}]}}}
InspectorIo::Write {"method":"Debugger.scriptParsed","params":{"scriptId":"14","url":"internal/async_hooks.js","startLine":0,"startColumn":0,"endLine":461,"endColumn":3,"executionContextId":1,"hash":"1d4f827543088b7323ff01654a1d939224c03abb","executionContextAuxData":{"isDefault":true},"isLiveEdit":false,"sourceMapURL":"","hasSourceURL":false,"isModule":false,"length":16009,"stackTrace":{"callFrames":[{"functionName":"NativeModule.compile","scriptId":"11","url":"internal/bootstrap/loaders.js","lineNumber":231,"columnNumber":21}]}}}
InspectorIo::PostIncomingMessage {"id":31,"method":"Page.getNavigationHistory","params":{}}
InspectorIo::Write {"method":"Debugger.scriptParsed","params":{"scriptId":"15","url":"internal/errors.js","startLine":0,"startColumn":0,"endLine":860,"endColumn":3,"executionContextId":1,"hash":"0cd53e529b459da90db5090e7b03f03d03227eba","executionContextAuxData":{"isDefault":true},"isLiveEdit":false,"sourceMapURL":"","hasSourceURL":false,"isModule":false,"length":31102,"stackTrace":{"callFrames":[{"functionName":"NativeModule.compile","scriptId":"11","url":"internal/bootstrap/loaders.js","lineNumber":231,"columnNumber":21}]}}}
InspectorIo::Write {"error":{"code":-32601,"message":"'Page.getNavigationHistory' wasn't found"},"id":31}
InspectorIo::Write {"method":"Debugger.scriptParsed","params":{"scriptId":"16","url":"util.js","startLine":0,"startColumn":0,"endLine":1363,"endColumn":3,"executionContextId":1,"hash":"0c6011d8311ee3d107928705c74484e471741f98","executionContextAuxData":{"isDefault":true},"isLiveEdit":false,"sourceMapURL":"","hasSourceURL":false,"isModule":false,"length":43955,"stackTrace":{"callFrames":[{"functionName":"NativeModule.compile","scriptId":"11","url":"internal/bootstrap/loaders.js","lineNumber":231,"columnNumber":21}]}}}
InspectorIo::Write {"method":"Debugger.scriptParsed","params":{"scriptId":"17","url":"internal/encoding.js","startLine":0,"startColumn":0,"endLine":560,"endColumn":3,"executionContextId":1,"hash":"151429775a7f8a681ec38ec6a08ceb3b1b491f3e","executionContextAuxData":{"isDefault":true},"isLiveEdit":false,"sourceMapURL":"","hasSourceURL":false,"isModule":false,"length":15874,"stackTrace":{"callFrames":[{"functionName":"NativeModule.compile","scriptId":"11","url":"internal/bootstrap/loaders.js","lineNumber":231,"columnNumber":21}]}}}
```
